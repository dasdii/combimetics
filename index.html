<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combimetics - Smarter Preisvergleich & Warenkorb-Optimierer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/2/2.1.0/iconify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Inter', sans-serif; }
      .modal-overlay { z-index: 100; }
      .cart-drawer { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-neutral-50 font-sans min-h-screen flex flex-col">
    
    <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 h-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
        <div class="flex h-full items-center justify-between">
          
          <div class="flex items-center cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.reload()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 607 205" class="h-16 w-auto">
              <clipPath id="cl_3"><rect y="0.00012207031" width="607" height="205"/></clipPath>
              <g clip-path="url(#cl_3)">
                <path fill="#314353" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M1087.85 502.067C1099.16 501.287 1125.63 501.683 1137.02 502.13C1134.67 543.848 1135.62 593.184 1136.29 635.23C1163.62 618.799 1176.23 606.66 1210.95 603.411C1244.49 600.455 1277.83 610.864 1303.72 632.371C1331.45 655.182 1348.8 688.213 1351.84 723.985C1355.24 763.237 1341.34 800.256 1316.19 830.052C1267.47 879.77 1203.26 882.672 1145.22 848.156C1142.45 846.513 1139.55 844.916 1136.76 843.301C1136.79 849.92 1138.72 861.739 1133.56 865.471C1125.59 865.115 1092.06 865.454 1087.95 863.377C1085.32 825.257 1087.95 773.38 1087.96 733.696L1088.87 558.805C1088.91 540.347 1087.62 519.516 1087.85 502.067ZM1230.47 821.918C1276.85 816.159 1309.81 773.937 1304.14 727.548C1298.47 681.159 1256.31 648.119 1209.91 653.702C1163.38 659.3 1130.24 701.597 1135.92 748.111C1141.61 794.625 1183.97 827.692 1230.47 821.918Z"/>
                <path fill="#314353" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M2273.67 107.698C2353.14 103.907 2420.65 165.252 2424.46 244.728C2428.27 324.205 2366.95 391.728 2287.47 395.56C2207.97 399.393 2140.41 338.038 2136.6 258.533C2132.79 179.028 2194.16 111.49 2273.67 107.698Z"/>
                <path fill="#ACB8BC" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M2268.96 118.837C2342.51 112.437 2407.29 166.973 2413.52 240.543C2419.75 314.114 2365.06 378.762 2291.47 384.815C2218.13 390.849 2153.75 336.381 2147.54 263.056C2141.33 189.731 2195.65 125.217 2268.96 118.837Z"/>
              </g>
            </svg>
          </div>

          <nav class="hidden md:flex items-center gap-8">
            <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900 transition-colors bg-transparent border-0 cursor-pointer" id="howItWorksLink">So funktioniert's</button>
            <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900 transition-colors bg-transparent border-0 cursor-pointer" id="popularProductsLink">Beliebte Produkte</button>
            <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900 transition-colors bg-transparent border-0 cursor-pointer" id="shopsLink">Partner & Shops</button>
          </nav>

          <div class="flex items-center gap-3">
            <button id="cartIconBtn" class="relative p-2 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors cursor-pointer">
              <span class="iconify w-6 h-6" data-icon="lucide:shopping-bag"></span>
              <span id="cartCountBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-xs font-medium rounded-full flex items-center justify-center hidden">0</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow sm:px-6 lg:px-8 lg:py-12 max-w-7xl w-full mx-auto pt-8 pr-4 pb-8 pl-4">
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-rose-50 text-rose-700 text-xs font-medium rounded-full mb-4">
          <span class="iconify w-3.5 h-3.5" data-icon="lucide:zap"></span> Smarte Warenkorb-Optimierung
        </div>
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-semibold tracking-tight text-neutral-900 mb-4">Finde den günstigsten Weg,<br class="hidden sm:block"> deine Beauty-Essentials zu kaufen</h1>
        <p class="text-base sm:text-lg text-neutral-500 max-w-2xl mx-auto">Vergleiche Preise über mehrere Shops und optimiere deinen Warenkorb für maximale Ersparnis, inklusive Versandkosten.</p>
      </div>

      <div class="max-w-2xl mx-auto mb-12">
        <div class="relative">
          <span class="iconify absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" data-icon="lucide:search"></span>
          <input type="text" id="searchInput" placeholder="Suche nach CeraVe, The Ordinary..." class="w-full pl-12 pr-4 py-4 bg-white border border-neutral-200 rounded-xl text-base text-neutral-900 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-rose-500/20 focus:border-rose-500 transition-all">
          <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-neutral-900 text-white text-sm font-medium rounded-lg hover:bg-neutral-800 transition-colors">Suchen</button>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div id="productsGrid" class="grid sm:grid-cols-2 gap-4"></div>
          <div id="emptyState" class="hidden bg-white border border-neutral-200 rounded-xl p-12 text-center">
            <h3 class="text-base font-medium text-neutral-900 mb-2">Keine Produkte gefunden</h3>
          </div>
        </div>

        <div id="basketSidebar" class="hidden lg:block lg:col-span-1">
          <div class="bg-white border border-neutral-200 rounded-xl sticky top-24 shadow-sm">
            <div class="p-5 border-b border-neutral-100 flex items-center justify-between">
              <h2 class="text-base font-semibold text-neutral-900">Dein Warenkorb</h2>
              <button id="clearBasket" class="text-xs text-neutral-500 hover:text-rose-600 transition-colors">Alle löschen</button>
            </div>
            <div id="basketItems" class="p-5 max-h-64 overflow-y-auto">
              <div id="basketEmpty" class="text-center py-8">
                <p class="text-sm text-neutral-500">Füge Produkte hinzu zum Vergleichen</p>
              </div>
              <div id="basketList" class="space-y-3 hidden"></div>
            </div>
            <div id="optimizationSection" class="border-t border-neutral-100 p-5 hidden bg-neutral-50/50">
              <div id="optionsList" class="space-y-3 mb-4"></div>
              <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg p-4 mt-4 border border-emerald-100">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-neutral-600 font-medium">Bester Preis</span>
                  <span id="bestPrice" class="text-lg font-bold text-emerald-700">€0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="shopComparison" class="mt-12 hidden">
        <h2 class="text-lg font-semibold tracking-tight text-neutral-900 mb-6">Detaillierter Shop-Vergleich</h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4" id="shopCards"></div>
      </div>
    </main>

    <footer class="bg-neutral-900 text-white mt-auto">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h3 class="font-bold mb-4">Combimetics</h3>
            <p class="text-sm text-neutral-400">Vergleiche smarter, spare mehr bei deiner Beauty-Routine.</p>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-4">Rechtliches</h3>
            <ul class="space-y-2 text-sm text-neutral-400">
              <li><a href="impressum.html" target="_blank" class="hover:text-white transition-colors">Impressum</a></li>
              <li><a href="datenschutz.html" target="_blank" class="hover:text-white transition-colors">Datenschutz</a></li>
              <li><a href="agb.html" target="_blank" class="hover:text-white transition-colors">AGB</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-4">Service</h3>
            <ul class="space-y-2 text-sm text-neutral-400">
              <li><a href="ueber-uns.html" target="_blank" class="hover:text-white transition-colors">Über uns</a></li>
              <li><a href="#" class="hover:text-white transition-colors">FAQ</a></li>
            </ul>
          </div>
        </div>
        <div class="border-t border-neutral-800 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
          <p class="text-xs text-neutral-500">© 2026 Combimetics Deutschland. Wir nutzen Affiliate-Links.</p>
        </div>
      </div>
    </footer>

    <div id="howItWorksModal" class="modal-overlay fixed inset-0 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full relative">
            <h3 class="text-xl font-bold mb-4">So funktioniert's</h3>
            <p class="text-neutral-600 mb-6">Wir berechnen automatisch, ob ein Split deines Warenkorbs günstiger ist, um Versandkostenfreigrenzen optimal auszunutzen.</p>
            <button onclick="document.getElementById('howItWorksModal').classList.add('hidden')" class="w-full py-3 bg-neutral-900 text-white rounded-lg">Verstanden</button>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- CONFIG & SUPABASE ---
        const SUPABASE_URL = 'https://ccoikocmrusafnelxzei.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_yXYlKpFHmDeTTN8L46CsRg_BXC3GlzB';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const shops = {
            'Douglas': { shipping: 3.95, freeShippingThreshold: 24.95 },
            'Sephora': { shipping: 4.95, freeShippingThreshold: 30 },
            'Flaconi': { shipping: 3.95, freeShippingThreshold: 19 },
            'Notino': { shipping: 2.95, freeShippingThreshold: 25 },
            'Shop Apotheke': { shipping: 0, freeShippingThreshold: 29 }
        };

        let products = [];
        let basket = [];

        // --- FETCH & RENDER ---
        async function loadData() {
            const { data: productData } = await supabase.from('products').select('*');
            const { data: priceData } = await supabase.from('prices').select('*');
            products = productData.map(prod => ({
                ...prod, prices: priceData.filter(p => p.ean === prod.ean)
            }));
            renderProducts(products);
        }

        function renderProducts(items) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = items.map(p => {
                const hasPrices = p.prices?.length > 0;
                const inBasket = basket.find(b => b.id === p.id);
                const minPrice = hasPrices ? Math.min(...p.prices.map(pr => pr.price)) : 0;

                return `
                    <div class="bg-white border border-neutral-200 rounded-xl p-4">
                        <img src="${p.image}" class="w-20 h-20 object-cover mb-4 rounded-lg">
                        <p class="text-xs font-bold uppercase text-neutral-400">${p.brand}</p>
                        <h3 class="text-sm font-medium mb-2 truncate">${p.name}</h3>
                        <p class="font-bold mb-4">${hasPrices ? 'ab €' + minPrice.toFixed(2) : 'Nicht verfügbar'}</p>
                        <button onclick="window.toggleBasket(${p.id})" ${!hasPrices ? 'disabled' : ''} class="w-full py-2 rounded-lg ${inBasket ? 'bg-rose-500 text-white' : 'bg-neutral-900 text-white disabled:bg-neutral-100'}">
                            ${inBasket ? 'Im Korb' : 'Hinzufügen'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.toggleBasket = (id) => {
            const prod = products.find(p => p.id === id);
            const idx = basket.findIndex(b => b.id === id);
            idx > -1 ? basket.splice(idx, 1) : basket.push(prod);
            renderBasket();
            renderProducts(products);
        };

        function renderBasket() {
            const list = document.getElementById('basketList');
            const count = basket.length;
            document.getElementById('cartCountBadge').textContent = count;
            document.getElementById('cartCountBadge').classList.toggle('hidden', count === 0);
            
            if(count === 0) {
                document.getElementById('basketEmpty').classList.remove('hidden');
                list.classList.add('hidden');
                document.getElementById('optimizationSection').classList.add('hidden');
            } else {
                document.getElementById('basketEmpty').classList.add('hidden');
                list.classList.remove('hidden');
                list.innerHTML = basket.map(b => `<div class="text-xs p-2 border-b">${b.name}</div>`).join('');
                calculateOptimization();
            }
        }

        function calculateOptimization() {
            document.getElementById('optimizationSection').classList.remove('hidden');
            document.getElementById('shopComparison').classList.remove('hidden');

            // Logik für besten Preis (Einzelshop vs Split)
            const options = Object.keys(shops).map(sName => {
                let sub = 0, missing = 0;
                basket.forEach(item => {
                    const p = item.prices.find(pr => pr.shop === sName);
                    if(p) sub += p.price; else missing++;
                });
                if(missing > 0) return null;
                const ship = sub >= shops[sName].freeShippingThreshold ? 0 : shops[sName].shipping;
                return { shop: sName, total: sub + ship, sub, ship };
            }).filter(Boolean);

            const winner = options.sort((a,b) => a.total - b.total)[0];
            document.getElementById('bestPrice').textContent = winner ? '€' + winner.total.toFixed(2) : 'N/A';
            
            document.getElementById('shopCards').innerHTML = options.map(o => `
                <div class="bg-white border p-4 rounded-xl">
                    <h4 class="font-bold">${o.shop}</h4>
                    <p class="text-sm">Total: €${o.total.toFixed(2)}</p>
                </div>
            `).join('');
        }

        // --- INITIALIZE & UI EVENTS ---
        loadData();
        document.getElementById('howItWorksLink').onclick = () => document.getElementById('howItWorksModal').classList.remove('hidden');
        document.getElementById('searchBtn').onclick = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(q) || p.brand.toLowerCase().includes(q)));
        };
      });
    </script>
</body>
</html>