<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combimetics - Beauty Preisvergleich</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/2/2.1.0/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Inter', sans-serif; }
      /* Modal Fix: Erzwingt die Zentrierung */
      .modal-overlay { 
          z-index: 999; 
          display: none; 
          align-items: center; 
          justify-content: center;
      }
      .modal-overlay.active { 
          display: flex !important; 
      }
    </style>
</head>
<body class="bg-neutral-50 font-sans min-h-screen flex flex-col">
    
    <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 h-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
        <div class="flex items-center cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.reload()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 607 205" class="h-16 w-auto">
              <clipPath id="cl_3"><rect y="0.00012207031" width="607" height="205"/></clipPath>
              <g clip-path="url(#cl_3)">
                <path fill="#314353" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M1087.85 502.067C1099.16 501.287 1125.63 501.683 1137.02 502.13C1134.67 543.848 1135.62 593.184 1136.29 635.23C1163.62 618.799 1176.23 606.66 1210.95 603.411C1244.49 600.455 1277.83 610.864 1303.72 632.371C1331.45 655.182 1348.8 688.213 1351.84 723.985C1355.24 763.237 1341.34 800.256 1316.19 830.052C1267.47 879.77 1203.26 882.672 1145.22 848.156C1142.45 846.513 1139.55 844.916 1136.76 843.301C1136.79 849.92 1138.72 861.739 1133.56 865.471C1125.59 865.115 1092.06 865.454 1087.95 863.377C1085.32 825.257 1087.95 773.38 1087.96 733.696L1088.87 558.805C1088.91 540.347 1087.62 519.516 1087.85 502.067ZM1230.47 821.918C1276.85 816.159 1309.81 773.937 1304.14 727.548C1298.47 681.159 1256.31 648.119 1209.91 653.702C1163.38 659.3 1130.24 701.597 1135.92 748.111C1141.61 794.625 1183.97 827.692 1230.47 821.918Z"/>
                <path fill="#314353" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M2273.67 107.698C2353.14 103.907 2420.65 165.252 2424.46 244.728C2428.27 324.205 2366.95 391.728 2287.47 395.56C2207.97 399.393 2140.41 338.038 2136.6 258.533C2132.79 179.028 2194.16 111.49 2273.67 107.698Z"/>
                <path fill="#ACB8BC" transform="matrix(0.200198 0 0 0.200391 0 0.00012207)" d="M2268.96 118.837C2342.51 112.437 2407.29 166.973 2413.52 240.543C2419.75 314.114 2365.06 378.762 2291.47 384.815C2218.13 390.849 2153.75 336.381 2147.54 263.056C2141.33 189.731 2195.65 125.217 2268.96 118.837Z"/>
              </g>
            </svg>
        </div>

        <nav class="hidden md:flex items-center gap-8">
          <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900" id="popularProductsLink">Beliebte Produkte</button>
          <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900" id="howItWorksLink">So funktioniert's</button>
        </nav>

        <button id="cartIconBtn" class="relative p-2 text-neutral-600">
            <span class="iconify w-6 h-6" data-icon="lucide:shopping-bag"></span>
            <span id="cartCountBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-xs font-medium rounded-full flex items-center justify-center hidden">0</span>
        </button>
      </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 sm:p-8">
      <div class="text-center mb-12 pt-8">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-neutral-900 mb-4">Smarter Beauty-Preisvergleich</h1>
        <p class="text-neutral-500 max-w-2xl mx-auto">Vergleiche Douglas, Sephora, Flaconi & Notino. Wir berechnen den besten Mix für dich.</p>
      </div>

      <div class="max-w-2xl mx-auto mb-12 flex gap-2">
        <input type="text" id="searchInput" placeholder="Marke oder Produkt suchen..." class="w-full p-4 border border-neutral-200 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 shadow-sm transition-all">
        <button id="searchBtn" class="px-8 bg-neutral-900 text-white rounded-xl font-medium hover:bg-neutral-800">Suchen</button>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div id="productsGrid" class="grid sm:grid-cols-2 gap-4"></div>
          <div id="paginationContainer" class="mt-8 text-center hidden">
             <button id="loadMoreBtn" class="px-8 py-3 border border-neutral-200 bg-white text-neutral-900 rounded-xl font-medium hover:bg-neutral-50 shadow-sm transition-all">
                Weitere Produkte anzeigen
             </button>
          </div>
        </div>

        <div id="basketSidebar" class="lg:col-span-1">
          <div class="bg-white border border-neutral-200 rounded-2xl sticky top-28 p-6 shadow-sm">
            <h2 class="font-bold text-lg mb-4">Warenkorb</h2>
            <div id="basketEmpty" class="text-center py-8 text-neutral-400 text-sm italic">Füge Produkte hinzu</div>
            <div id="basketList" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2"></div>
            
            <div id="optimizationSection" class="border-t pt-6 hidden">
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center mb-4">
                    <span class="text-emerald-800 text-sm font-bold uppercase tracking-tight">Bestpreis:</span>
                    <span id="bestPrice" class="text-2xl font-black text-emerald-700">€0.00</span>
                </div>
                <p class="text-[10px] text-neutral-400 text-center uppercase tracking-widest font-bold">Optimierung aktiv</p>
            </div>
          </div>
        </div>
      </div>

      <div id="shopComparison" class="mt-16 hidden">
        <h2 class="text-xl font-bold mb-8">Detaillierter Shop-Vergleich</h2>
        <div id="shopCards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      </div>
    </main>

    <footer class="bg-neutral-900 text-white py-16 px-8 mt-20 border-t border-neutral-800">
      <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-12">
        <div>
            <h3 class="font-bold text-xl mb-4">Combimetics</h3>
            <p class="text-neutral-400 text-sm leading-relaxed">Dein smarter Preisvergleich für Parfüm & Skincare.</p>
        </div>
        <div>
            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-neutral-500">Rechtliches</h3>
            <ul class="space-y-3 text-sm text-neutral-400">
                <li><a href="impressum.html" class="hover:text-white transition-colors">Impressum</a></li>
                <li><a href="datenschutz.html" class="hover:text-white transition-colors">Datenschutz</a></li>
                <li><a href="agb.html" class="hover:text-white transition-colors">AGB</a></li>
            </ul>
        </div>
        <div>
            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-neutral-500">Service</h3>
            <ul class="space-y-3 text-sm text-neutral-400">
                <li><a href="ueber-uns.html" class="hover:text-white transition-colors">Über uns</a></li>
            </ul>
        </div>
      </div>
      <div class="max-w-7xl mx-auto mt-12 pt-8 border-t border-neutral-800 text-center text-[10px] text-neutral-600">
        © 2026 Combimetics. Affiliate-Links enthalten.
      </div>
    </footer>

    <div id="howItWorksModal" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full relative shadow-2xl text-center">
            <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="iconify text-rose-500 w-8 h-8" data-icon="lucide:zap"></span>
            </div>
            <h3 class="text-2xl font-bold mb-4 text-neutral-900">Smart-Cart Logic</h3>
            <p class="text-neutral-600 text-sm leading-relaxed mb-8">Wir prüfen live, ob es günstiger ist, den Warenkorb aufzuteilen, um Versandkostenfreigrenzen bei verschiedenen Shops zu erreichen.</p>
            <button id="closeHowItWorks" class="w-full py-4 bg-neutral-900 text-white rounded-2xl font-bold hover:bg-neutral-800 transition-all shadow-lg">Verstanden</button>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const SUPABASE_URL = 'https://ccoikocmrusafnelxzei.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_yXYlKpFHmDeTTN8L46CsRg_BXC3GlzB';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const shops = {
            'Douglas': { shipping: 3.95, threshold: 24.95 },
            'Sephora': { shipping: 4.95, threshold: 30.00 },
            'Flaconi': { shipping: 3.95, threshold: 19.00 },
            'Notino': { shipping: 2.95, threshold: 25.00 }
        };

        let allProducts = [];
        let displayedProducts = [];
        let basket = [];
        let visibleCount = 10;

        async function loadData() {
            const { data: pData } = await supabase.from('products').select('*');
            const { data: prData } = await supabase.from('prices').select('*');
            allProducts = pData.map(p => ({ ...p, prices: prData.filter(x => x.ean === p.ean) }));
            displayedProducts = [...allProducts];
            renderProducts();
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const btnContainer = document.getElementById('paginationContainer');
            const slice = displayedProducts.slice(0, visibleCount);
            
            grid.innerHTML = slice.map(p => {
                const hasPr = p.prices?.length > 0;
                const inB = basket.find(b => b.id === p.id);
                const min = hasPr ? Math.min(...p.prices.map(x => x.price)) : 0;
                return `
                    <div class="bg-white border border-neutral-200 rounded-2xl p-5 hover:shadow-lg transition-all flex flex-col group">
                        <img src="${p.image}" class="w-full h-40 object-contain mb-4 rounded-lg group-hover:scale-105 transition-transform">
                        <p class="text-[10px] font-black uppercase text-neutral-400 mb-1">${p.brand}</p>
                        <h3 class="text-sm font-semibold mb-2 h-10 overflow-hidden">${p.name}</h3>
                        <p class="text-lg font-bold text-neutral-900 mb-4">${hasPr ? '€' + min.toFixed(2) : 'n/a'}</p>
                        <button onclick="window.toggleBasket(${p.id})" ${!hasPr ? 'disabled' : ''} class="w-full py-3 rounded-xl font-bold text-xs ${inB ? 'bg-rose-500 text-white' : 'bg-neutral-900 text-white'}">
                            ${inB ? '✓ Im Korb' : '+ Hinzufügen'}
                        </button>
                    </div>
                `;
            }).join('');
            
            btnContainer.classList.toggle('hidden', displayedProducts.length <= visibleCount);
        }

        document.getElementById('loadMoreBtn').onclick = () => {
            visibleCount += 30;
            renderProducts();
        };

        window.toggleBasket = (id) => {
            const p = allProducts.find(x => x.id === id);
            const idx = basket.findIndex(b => b.id === id);
            if(idx > -1) basket.splice(idx, 1); else basket.push(p);
            updateUI();
        };

        function updateUI() {
            const list = document.getElementById('basketList');
            document.getElementById('cartCountBadge').textContent = basket.length;
            document.getElementById('cartCountBadge').classList.toggle('hidden', basket.length === 0);
            document.getElementById('basketEmpty').classList.toggle('hidden', basket.length > 0);
            
            list.innerHTML = basket.map(b => `
                <div class="flex justify-between items-center p-3 bg-neutral-50 rounded-xl border border-neutral-100">
                    <span class="text-[10px] font-medium truncate w-32">${b.name}</span>
                    <button onclick="window.toggleBasket(${b.id})" class="text-neutral-400 hover:text-rose-500"><span class="iconify" data-icon="lucide:trash-2"></span></button>
                </div>
            `).join('');
            
            if(basket.length > 0) calculateOptimization();
            else {
                document.getElementById('optimizationSection').classList.add('hidden');
                document.getElementById('shopComparison').classList.add('hidden');
            }
            renderProducts();
        }

        function calculateOptimization() {
            document.getElementById('optimizationSection').classList.remove('hidden');
            document.getElementById('shopComparison').classList.remove('hidden');

            const options = Object.keys(shops).map(sName => {
                let sub = 0, missing = 0;
                basket.forEach(item => {
                    const p = item.prices.find(pr => pr.shop === sName);
                    if(p) sub += p.price; else missing++;
                });
                const ship = sub >= shops[sName].threshold ? 0 : shops[sName].shipping;
                return { name: sName, total: sub + ship, sub, ship, missing };
            });

            let splitSub = 0, splitShip = 0;
            const shopGroups = {};
            basket.forEach(item => {
                const best = item.prices.reduce((min, p) => p.price < min.price ? p : min, item.prices[0]);
                if(best) {
                    splitSub += best.price;
                    shopGroups[best.shop] = (shopGroups[best.shop] || 0) + best.price;
                }
            });
            Object.keys(shopGroups).forEach(s => { if(shopGroups[s] < shops[s].threshold) splitShip += shops[s].shipping; });
            const splitOption = { name: 'Mix & Match', total: splitSub + splitShip, sub: splitSub, ship: splitShip, isSplit: true };

            const allResults = [splitOption, ...options].sort((a,b) => a.total - b.total);
            document.getElementById('bestPrice').textContent = '€' + allResults[0].total.toFixed(2);
            
            document.getElementById('shopCards').innerHTML = allResults.map((o, i) => `
                <div class="bg-white border ${i === 0 ? 'border-emerald-500 ring-4 ring-emerald-50' : 'border-neutral-200'} p-6 rounded-3xl shadow-sm">
                    <h4 class="font-black text-neutral-900 mb-4 uppercase text-xs tracking-widest">${o.name}</h4>
                    <div class="text-[11px] space-y-2 text-neutral-500 mb-4">
                        <div class="flex justify-between"><span>Artikel</span><span>€${o.sub.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Versand</span><span>${o.ship === 0 ? 'GRATIS' : '€'+o.ship.toFixed(2)}</span></div>
                        ${o.missing > 0 ? `<div class="text-rose-500 font-bold">${o.missing} Produkt(e) fehlen</div>` : ''}
                    </div>
                    <div class="border-t pt-4 flex justify-between items-center font-black">
                        <span>Total</span><span class="text-lg ${i === 0 ? 'text-emerald-600' : ''}">€${o.total.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('howItWorksLink').onclick = () => document.getElementById('howItWorksModal').classList.add('active');
        document.getElementById('closeHowItWorks').onclick = () => document.getElementById('howItWorksModal').classList.remove('active');
        
        document.getElementById('searchBtn').onclick = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            displayedProducts = allProducts.filter(p => p.name.toLowerCase().includes(q) || p.brand.toLowerCase().includes(q));
            visibleCount = 10;
            renderProducts();
        };

        loadData();
      });
    </script>
</body>
</html>