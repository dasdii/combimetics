<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combimetics - Smarter Preisvergleich</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/2/2.1.0/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Inter', sans-serif; }
      .modal-overlay { z-index: 100; }
    </style>
</head>
<body class="bg-neutral-50 font-sans min-h-screen flex flex-col">
    
    <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 h-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
        <div class="flex items-center cursor-pointer" onclick="window.location.reload()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 607 205" class="h-16 w-auto">
              <path fill="#314353" d="M1087.85 502.067C1099.16 501.287 1125.63 501.683 1137.02 502.13C1134.67 543.848 1135.62 593.184 1136.29 635.23C1163.62 618.799 1176.23 606.66 1210.95 603.411C1244.49 600.455 1277.83 610.864 1303.72 632.371C1331.45 655.182 1348.8 688.213 1351.84 723.985C1355.24 763.237 1341.34 800.256 1316.19 830.052C1267.47 879.77 1203.26 882.672 1145.22 848.156C1142.45 846.513 1139.55 844.916 1136.76 843.301C1136.79 849.92 1138.72 861.739 1133.56 865.471C1125.59 865.115 1092.06 865.454 1087.95 863.377C1085.32 825.257 1087.95 773.38 1087.96 733.696L1088.87 558.805C1088.91 540.347 1087.62 519.516 1087.85 502.067ZM1230.47 821.918C1276.85 816.159 1309.81 773.937 1304.14 727.548C1298.47 681.159 1256.31 648.119 1209.91 653.702C1163.38 659.3 1130.24 701.597 1135.92 748.111C1141.61 794.625 1183.97 827.692 1230.47 821.918Z" transform="scale(0.2)"/>
              <text x="140" y="140" font-family="Inter" font-weight="bold" font-size="80" fill="#314353">COMBIMETICS</text>
          </svg>
        </div>

        <nav class="hidden md:flex items-center gap-8">
          <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900" id="popularProductsLink">Beliebte Produkte</button>
          <button class="text-sm font-medium text-neutral-600 hover:text-neutral-900" id="howItWorksLink">So funktioniert's</button>
        </nav>

        <button id="cartIconBtn" class="relative p-2 text-neutral-600">
            <span class="iconify w-6 h-6" data-icon="lucide:shopping-bag"></span>
            <span id="cartCountBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-xs font-medium rounded-full flex items-center justify-center hidden">0</span>
        </button>
      </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 sm:p-8">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-extrabold text-neutral-900 mb-4">Smarter Beauty-Preisvergleich</h1>
        <p class="text-neutral-500">Wir optimieren deinen Warenkorb über alle Shops hinweg.</p>
      </div>

      <div class="max-w-2xl mx-auto mb-12 flex gap-2">
        <input type="text" id="searchInput" placeholder="Suche nach CeraVe, Dior..." class="w-full p-4 border border-neutral-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none">
        <button id="searchBtn" class="px-8 bg-neutral-900 text-white rounded-xl font-medium">Suchen</button>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div id="productsGrid" class="grid sm:grid-cols-2 gap-4"></div>
        </div>

        <div id="basketSidebar" class="lg:col-span-1">
          <div class="bg-white border border-neutral-200 rounded-2xl sticky top-28 p-6 shadow-sm">
            <h2 class="font-bold text-lg mb-4">Dein Warenkorb</h2>
            <div id="basketEmpty" class="text-center py-8 text-neutral-400 text-sm">Noch keine Produkte im Korb</div>
            <div id="basketList" class="space-y-3 mb-6"></div>
            
            <div id="optimizationSection" class="border-t pt-6 hidden">
                <div id="optionsList" class="mb-4"></div>
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center">
                    <span class="text-emerald-800 text-sm font-medium">Bestpreis Gesamt:</span>
                    <span id="bestPrice" class="text-xl font-black text-emerald-700">€0.00</span>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div id="shopComparison" class="mt-16 hidden">
        <h2 class="text-xl font-bold mb-6">Detaillierter Shop-Vergleich</h2>
        <div id="shopCards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
      </div>
    </main>

    <footer class="bg-neutral-900 text-white py-16 px-8 mt-20">
      <div class="max-w-7xl mx-auto grid md:grid-cols-3 gap-12">
        <div>
            <h3 class="font-bold text-xl mb-4">Combimetics</h3>
            <p class="text-neutral-400 text-sm">Die schlauste Art, Beauty-Produkte online zu kaufen. Spare Versandkosten durch intelligente Warenkorb-Aufteilung.</p>
        </div>
        <div>
            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-neutral-500">Rechtliches</h3>
            <ul class="space-y-3 text-sm text-neutral-400">
                <li><a href="impressum.html" class="hover:text-white transition-colors">Impressum</a></li>
                <li><a href="datenschutz.html" class="hover:text-white transition-colors">Datenschutz</a></li>
                <li><a href="agb.html" class="hover:text-white transition-colors">AGB</a></li>
            </ul>
        </div>
        <div>
            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-neutral-500">Service</h3>
            <ul class="space-y-3 text-sm text-neutral-400">
                <li><a href="ueber-uns.html" class="hover:text-white transition-colors">Über uns</a></li>
                <li><a href="#" class="hover:text-white transition-colors">FAQ</a></li>
            </ul>
        </div>
      </div>
      <div class="max-w-7xl mx-auto mt-12 pt-8 border-t border-neutral-800 text-center text-xs text-neutral-600">
        © 2026 Combimetics Deutschland. Wir nutzen Affiliate-Links zur Finanzierung.
      </div>
    </footer>

    <div id="howItWorksModal" class="modal-overlay fixed inset-0 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full relative shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Der Smart-Cart Algorithmus</h3>
            <p class="text-neutral-600 text-sm leading-relaxed mb-6">Manchmal ist es günstiger, Produkte bei zwei verschiedenen Shops zu bestellen, um überall über die Versandkostenfreigrenze zu kommen, anstatt alles bei einem Shop zu kaufen und dort hohe Gebühren zu zahlen. Wir berechnen das für dich!</p>
            <button onclick="document.getElementById('howItWorksModal').classList.add('hidden')" class="w-full py-3 bg-neutral-900 text-white rounded-xl font-bold">Verstanden</button>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- CONFIG & SUPABASE ---
        const SUPABASE_URL = 'https://ccoikocmrusafnelxzei.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_yXYlKpFHmDeTTN8L46CsRg_BXC3GlzB';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const shops = {
            'Douglas': { shipping: 3.95, threshold: 24.95 },
            'Sephora': { shipping: 4.95, threshold: 30.00 },
            'Flaconi': { shipping: 3.95, threshold: 19.00 },
            'Notino': { shipping: 2.95, threshold: 25.00 }
        };

        let products = [];
        let basket = [];

        // --- CORE LOGIC ---
        async function loadData() {
            const { data: pData } = await supabase.from('products').select('*');
            const { data: prData } = await supabase.from('prices').select('*');
            products = pData.map(p => ({ ...p, prices: prData.filter(x => x.ean === p.ean) }));
            renderProducts(products);
        }

        function renderProducts(items) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = items.map(p => {
                const hasPr = p.prices?.length > 0;
                const inB = basket.find(b => b.id === p.id);
                const min = hasPr ? Math.min(...p.prices.map(x => x.price)) : 0;
                return `
                    <div class="bg-white border border-neutral-200 rounded-2xl p-5 hover:shadow-lg transition-all">
                        <img src="${p.image}" class="w-full h-40 object-contain mb-4 rounded-lg">
                        <p class="text-[10px] font-black uppercase text-neutral-400 tracking-widest">${p.brand}</p>
                        <h3 class="text-sm font-semibold mb-2 h-10 overflow-hidden">${p.name}</h3>
                        <p class="text-lg font-bold mb-4">${hasPr ? '€' + min.toFixed(2) : 'n/a'}</p>
                        <button onclick="window.toggleBasket(${p.id})" ${!hasPr ? 'disabled' : ''} class="w-full py-3 rounded-xl font-bold text-sm transition-all ${inB ? 'bg-rose-500 text-white' : 'bg-neutral-900 text-white disabled:bg-neutral-100'}">
                            ${inB ? '✓ Im Korb' : '+ Hinzufügen'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.toggleBasket = (id) => {
            const p = products.find(x => x.id === id);
            const idx = basket.findIndex(b => b.id === id);
            if(idx > -1) basket.splice(idx, 1); else basket.push(p);
            renderBasket();
            renderProducts(products);
        };

        function renderBasket() {
            const list = document.getElementById('basketList');
            const count = basket.length;
            document.getElementById('cartCountBadge').textContent = count;
            document.getElementById('cartCountBadge').classList.toggle('hidden', count === 0);
            document.getElementById('basketEmpty').classList.toggle('hidden', count > 0);
            
            list.innerHTML = basket.map(b => `
                <div class="flex justify-between items-center p-3 bg-neutral-50 rounded-xl border border-neutral-100">
                    <span class="text-xs font-medium truncate w-32">${b.name}</span>
                    <span class="text-xs font-bold">€${Math.min(...b.prices.map(x => x.price)).toFixed(2)}</span>
                </div>
            `).join('');
            
            if(count > 0) calculateOptimization(); else {
                document.getElementById('optimizationSection').classList.add('hidden');
                document.getElementById('shopComparison').classList.add('hidden');
            }
        }

        function calculateOptimization() {
            document.getElementById('optimizationSection').classList.remove('hidden');
            document.getElementById('shopComparison').classList.remove('hidden');

            const results = Object.keys(shops).map(sName => {
                let sub = 0, missing = 0;
                basket.forEach(item => {
                    const p = item.prices.find(pr => pr.shop === sName);
                    if(p) sub += p.price; else missing++;
                });
                if(missing > 0) return null;
                const ship = sub >= shops[sName].threshold ? 0 : shops[sName].shipping;
                return { name: sName, total: sub + ship, sub, ship };
            }).filter(Boolean).sort((a,b) => a.total - b.total);

            const winner = results[0];
            document.getElementById('bestPrice').textContent = winner ? '€' + winner.total.toFixed(2) : 'N/A';
            
            document.getElementById('shopCards').innerHTML = results.map((o, i) => `
                <div class="bg-white border ${i === 0 ? 'border-emerald-500 ring-2 ring-emerald-500 ring-offset-2' : 'border-neutral-200'} p-6 rounded-2xl">
                    <h4 class="font-black text-neutral-900 mb-4">${o.name}</h4>
                    <div class="text-xs space-y-2 text-neutral-500 mb-4">
                        <div class="flex justify-between"><span>Artikel</span><span>€${o.sub.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Versand</span><span>${o.ship === 0 ? 'GRATIS' : '€'+o.ship.toFixed(2)}</span></div>
                    </div>
                    <div class="border-t pt-4 flex justify-between items-center">
                        <span class="text-sm font-bold">Total</span>
                        <span class="text-lg font-black ${i === 0 ? 'text-emerald-600' : ''}">€${o.total.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- UI EVENTS ---
        document.getElementById('howItWorksLink').onclick = () => document.getElementById('howItWorksModal').classList.remove('hidden');
        document.getElementById('popularProductsLink').onclick = () => {
            renderProducts(products.filter(p => p.trending));
            window.scrollTo({ top: 500, behavior: 'smooth' });
        };
        document.getElementById('searchBtn').onclick = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(q) || p.brand.toLowerCase().includes(q)));
        };

        loadData();
      });
    </script>
</body>
</html>